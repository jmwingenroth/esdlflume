---
title: "fauria model"
output: html_document
---

# Intro

This script applies the model from Fauria et al. 2014 (AGU Water Resources Research) to data from our follow-up experiment. Whereas Fauria et al. used a Laser In-Situ Scattering Transmitter (LISST), the data analyzed in this script, at least to begin with, will be total mass/volume concentrations, calculated from data generated by pump sample filtering.

# Libraries

```{r}
library(tidyverse)
library(R.matlab)
library(broom)
```


# Import pump data

```{r}
pumpdata920 <- read_csv("../data/raw/920pumpdata.csv")
pumpdata1005 <- read_csv("../data/raw/1005pumpdata.csv")
pumpdata1019 <- read_csv("../data/raw/1019pumpdata.csv")

```

# Tidy pump data

Each month was entered with slightly different formatting and with different correspondence between 'timesteps' and actual times. Here we'll put the data into one table that has valid measurements, important factors, and universally applicable metrics for time (seconds).

```{r}
#oct 05 run had 2 blanks then was collected every five minutes, beginning at 10m

pumpdata1005 <- pumpdata1005 %>%
  filter(`time series`>2) %>%
  rename(time = `time series`, mvc = `mass volume concentration (ppm)`) %>%
  mutate(time = (time-1)*300, run = "oct05") %>%
  select(run, 2:9)

pumpdata920 <- pumpdata920 %>%
  filter(`time series`>1) %>%
  rename(time = `time series`, mvc = `mass volume concentration (ppm)`) %>%
  mutate(time = time*300, run = "sep20") %>%
  select(run, 2:9)

pumpdata1019 <- pumpdata1019 %>%
  filter(`time series`>1) %>%
  rename(time = `Sample Time (s)`, mvc = `mass volume concentration (ppm)`) %>%
  mutate(run = "oct 19") %>%
  select(run, time, 3:9)

pump <- rbind(pumpdata1005, pumpdata920, pumpdata1019)

pump <- mutate(pump, mvc = as.numeric(mvc))

```

# Import vectrino data

```{r}
vectrino920 <- readMat("../data/raw/920vectrino.mat")
vectrino1005 <- readMat("../data/raw/1005vectrino.mat")
```

# Tidy vectrino data and calculate velocities for runs

absolute velocity calculated from x, y, and z data, ignoring directionality for the time being. The absolute velocity is in meters per second. The pump frequencies were 30 hertz for sep 20 and 15 hertz for october 5

```{r}
vel920 <- vectrino920$Data[3:6]
vel1005 <- vectrino1005$Data[3:6]

for (i in 1:length(vel920)) vel920[[i]][[1]] <- rowMeans(vel920[[i]][[1]])

vel920 <- sqrt(vel920[[1]][[1]]^2 + vel920[[2]][[1]]^2 + vel920[[3]][[1]]^2)

for (i in 1:length(vel1005)) vel1005[[i]][[1]] <- rowMeans(vel1005[[i]][[1]])

vel1005 <- sqrt(vel1005[[1]][[1]]^2 + vel1005[[2]][[1]]^2 + vel1005[[3]][[1]]^2)

boxplot(vel920[20000:60000], vel1005[20000:60000])
mean(vel920[20000:60000])
mean(vel1005[20000:60000])

rm(vectrino1005, vectrino920)
```

These flow velocities are close enough to our expected ratio, 2:1, that I'm comfortable just using that.

# Sediment trap data

We employed nine small sediment traps on the bottom to get absolute values for particle settling. These can be used in tandem with the pump samples to differentiate between settling and collection. Traps were given alphabetical identifiers, beginning with the A, upstream-leftmost sediment trap, and progressing left to right, then upstream to downstream, ending with the I, the downstream-rightmost trap. All units are milligrams.

Trap diameter was 17/16", or 2.698 cm. Hence, the area is in cm^2. Density is in mg/cm^2.

```{r}
trap920 <- read_csv("../data/raw/920trapdata.csv")
trap1005 <- read_csv("../data/raw/1005trapdata.csv")

trap1005 <- trap1005 %>%
  mutate('sediment mass' = post - pre, run = "oct05") %>%
  rename('trap letter' = X1)

trap920 <- trap920 %>%
  mutate(run = "sep20")

trap <- rbind(trap920, trap1005)

trap_area <- pi*(2.698^2/4)

trap <- trap %>%
  mutate(density = `sediment mass`/trap_area)

trap %>%
  ggplot(aes(run, density)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(trap$density)) +
  ylab("settled density")

rm(trap1005, trap920)
```


# Exponential model

The formula from Fauria for water concentration over time in a flume of constant velocity follows an exponential form: 

$$ \phi_a = \phi_{a,0} \cdot e^{kt} $$

$\phi_a$ is concentration at height $a$. $k$ is a coefficient, comprising settling ($k_s$) and particle capture on stems ($k_c$). $t$ is time. For the runs in this model so far, there have been zero collectors, meaining $k = k_s$. $k_s$ is calculated from another equation. We need to figure out vertical diffusion still to get an expected ratio to compare our model against, but $k \sim 1 - \frac{C}{u}$, where $u$ is flow velocity. Hence, lower velocity would be predicted to result in a lower k.

```{r}
  
model1005 <- lm(log(mvc) ~ time, data = filter(pump, run=="oct05"))
summary(model1005)

model920 <- lm(log(mvc) ~ time, data = filter(pump, run=="sep20"))
summary(model920)

model1019 <- lm(log(mvc) ~ time, data = filter(pump, run=="oct 19"))
summary(model1019)

model1019s <-lm(log(mvc) ~ time, data = filter(pump, run=="oct 19", time<6001))
summary(model1019s)

model1019l <-lm(log(mvc) ~ time, data = filter(pump, run=="oct 19", time>6001))
summary(model1019l)

pump %>%
  filter(time<6001) %>%
  ggplot(aes(time, mvc, color = run, group = time)) +
  geom_jitter(alpha = .6) +
  scale_color_manual(values = c("red","blue","green")) +
  stat_function(fun = function(x) exp(model920$coefficients[1]+model920$coefficients[2]*x), color = "green") +
  stat_function(fun = function(x) exp(model1005$coefficients[1]+model1005$coefficients[2]*x), color = "blue") +
  stat_function(fun = function(x) exp(model1019s$coefficients[1]+model1019s$coefficients[2]*x), color = "red") +
  xlab("sec") +
  ylab("ppm")
  
pump %>%
  filter(run=="oct 19") %>%
  ggplot(aes(time, mvc)) +
  geom_jitter() +
  stat_function(fun = function(x) exp(model1019$coefficients[1]+model1019$coefficients[2]*x), color = "blue") +
  stat_function(fun = function(x) exp(model1019s$coefficients[1]+model1019s$coefficients[2]*x), color = "red") +
  stat_function(fun = function(x) exp(model1019l$coefficients[1]+model1019l$coefficients[2]*x), color = "green")
  

```

```{r}

subset_model <- function(start = 600, increment = 600, n = 8) {
  
  stattable <- tibble(start = 0,
                        end = 0,
                        sep20k = 0,
                        sep20r2 = 0,
                        oct05k = 0,
                        oct05r2 = 0,
                        oct19k = 0,
                        oct19r2 = 0)
    
  for (i in 1:n) {
  
    temp <- pump %>%
      filter(time>start, time<(start + increment*i))
    
    sep20 <- lm(log(mvc) ~ time, data = filter(temp, run == 'sep20'))
    oct05 <- lm(log(mvc) ~ time, data = filter(temp, run == 'oct05'))
    oct19 <- lm(log(mvc) ~ time, data = filter(temp, run == 'oct 19'))
    
    stattable[i, 1] <- start
    stattable[i, 2] <- start + increment*i
    stattable[i, 3] <- tidy(sep20)$estimate[2]
    stattable[i, 4] <- glance(sep20)$r.squared
    stattable[i, 5] <- tidy(oct05)$estimate[2]
    stattable[i, 6] <- glance(oct05)$r.squared
    stattable[i, 7] <- tidy(oct19)$estimate[2]
    stattable[i, 8] <- glance(oct19)$r.squared
  }
  
  return(stattable)
}

subset_model(500, 400, 14)

```

